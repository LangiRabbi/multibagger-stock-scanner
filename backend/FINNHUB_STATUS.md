# üéØ FINNHUB FREE TIER - SZCZEG√ì≈ÅOWA ANALIZA I STATUS

**Data utworzenia raportu:** 2025-10-07
**Ostatni commit:** `161f45b` - Research: Finnhub FREE tier analysis
**Autor:** Lang Rabar

---

## üìã PODSUMOWANIE OSTATNIEGO COMMITA

### G≈Ç√≥wne ustalenia z bada≈Ñ:

Commit `161f45b` zawiera kompleksowe testy wszystkich endpoint√≥w Finnhub API w celu okre≈õlenia, co faktycznie dzia≈Ça na **FREE tier**.

**Kluczowe odkrycie:**
- ‚ùå **Volume NIE jest dostƒôpny** w `/quote` endpoint (zwraca `None`)
- ‚úÖ Wszystkie **fundamentals sƒÖ dostƒôpne** (131 metryk!)
- ‚úÖ Hybrid approach: **yfinance (volume) + Finnhub (fundamentals)**

---

## ‚úÖ CO DZIA≈ÅA NA FREE TIER

### 1. **Quote Endpoint** (`/quote`)
**Status:** ‚úÖ Dzia≈Ça (HTTP 200)

**Dostƒôpne dane:**
- ‚úÖ `c` - Current Price: $256.48 (AAPL)
- ‚úÖ `h` - High price
- ‚úÖ `l` - Low price
- ‚úÖ `o` - Open price
- ‚úÖ `pc` - Previous Close
- ‚úÖ `t` - Timestamp
- ‚ùå **`v` - Volume: `None`** - **KRYTYCZNE: Volume NOT available!**

**Implementacja w scanner.py:**
```python
quote = finnhub.get_quote(symbol)
current_price = quote['c']  # ‚úÖ Dzia≈Ça
```

---

### 2. **Company Profile** (`/company-profile2`)
**Status:** ‚úÖ Dzia≈Ça (HTTP 200)

**Dostƒôpne dane:**
- ‚úÖ `marketCapitalization`: 3,809,379 (warto≈õƒá w MILIONACH!)
- ‚úÖ `shareOutstanding`: 14,840.39
- ‚úÖ `name`: Company name
- ‚úÖ `industry`: Industry sector

**UWAGA:** Market Cap zwracany jest w milionach, wymaga konwersji:

**Implementacja w scanner.py:**
```python
profile = finnhub.get_company_profile(symbol)
market_cap_millions = profile['marketCapitalization']
market_cap = int(market_cap_millions * 1_000_000)  # Konwersja z M na pe≈ÇnƒÖ warto≈õƒá
```

---

### 3. **Basic Financials** (`/company_basic_financials?metric=all`)
**Status:** ‚úÖ Dzia≈Ça (HTTP 200) - **131 metryk dostƒôpnych!**

**Kluczowe metryki dla multibagger scanner:**

| Metryka | Klucz Finnhub | Przyk≈Çad (AAPL) | Status |
|---------|---------------|-----------------|--------|
| **ROE** | `roeTTM` | 154.92% | ‚úÖ |
| **ROCE** | `series.annual.roic[0].v` | 0.5699 (56.99%) | ‚úÖ |
| **Debt/Equity** | `totalDebt/totalEquityAnnual` | 1.8881 | ‚úÖ |
| **Revenue Growth** | `revenueGrowthTTMYoy` | 5.97% | ‚úÖ |
| **P/E Ratio** | `peTTM` | 38.38 | ‚úÖ |
| **Net Margin** | `netProfitMarginTTM` | 24.3% | ‚úÖ |
| **Operating Margin** | `operatingMarginTTM` | 31.87% | ‚úÖ |

**Implementacja w scanner.py (linie 106-137):**
```python
fundamentals = finnhub.get_fundamentals(symbol)
metrics = fundamentals['metric']

# ROE (Return on Equity) - ju≈º w %
roe = metrics.get('roeTTM', 0)

# ROCE (Return on Capital Employed)
# UWAGA: ROCE NIE jest w metrics! Jest w series.annual.roic
roce = 0
if 'series' in fundamentals and 'annual' in fundamentals['series']:
    roic_series = fundamentals['series']['annual'].get('roic', [])
    if roic_series and len(roic_series) > 0:
        # roic to lista dict: [{'period': '2023-09-30', 'v': 0.4532}]
        # warto≈õƒá to decimal, konwertujemy na %
        roce = roic_series[0].get('v', 0) * 100 if roic_series[0].get('v') else 0

# Debt/Equity - UWAGA: Klucz zawiera "/" w nazwie!
debt_equity = metrics.get('totalDebt/totalEquityAnnual', 999)

# P/E Ratio TTM
forward_pe = metrics.get('peTTM', 999)

# Revenue Growth TTM YoY
revenue_growth = metrics.get('revenueGrowthTTMYoy', 0)
```

---

### 4. **Financials Reported** (`/financials-reported`)
**Status:** ‚úÖ Dzia≈Ça (HTTP 200)

**Dostƒôpne dane:**
- ‚úÖ 15 data entries
- ‚ö†Ô∏è Nie testowane szczeg√≥≈Çowo w tym commicie

---

## ‚ùå CO NIE DZIA≈ÅA (403 Forbidden)

### 1. **Stock Candles** (`/stock/candles`)
**Status:** ‚ùå HTTP 403 Forbidden (Premium only)

**Pow√≥d:** OHLCV data (Open, High, Low, Close, Volume) jest dostƒôpne tylko na p≈Çatnych planach.

---

### 2. **Financials** (`/financials`)
**Status:** ‚ùå HTTP 403 Forbidden (Premium only)

**Pow√≥d:** Pe≈Çne Income Statement i Balance Sheet wymagajƒÖ premium.

---

## üîß ROZWIƒÑZANIE: HYBRID APPROACH

### Strategia:
Poniewa≈º **Finnhub FREE nie ma volume**, ale **yfinance ma volume za darmo**, implementujemy **podej≈õcie hybrydowe**:

1. **yfinance** ‚Üí Volume + Price Changes (7d, 30d)
2. **Finnhub** ‚Üí Wszystkie fundamentals (ROE, ROCE, Debt/Equity, etc.)

### Implementacja w scanner.py:

**yfinance (tylko dla volume + price changes):**
```python
import yfinance as yf

ticker = yf.Ticker(symbol)

# Volume z 1-dniowej historii
hist = ticker.history(period="1d")
current_volume = int(hist["Volume"].iloc[-1])  # ‚úÖ Dzia≈Ça

# Price changes z 1-miesiƒôcznej historii
hist_month = ticker.history(period="1mo")
price_change_7d = ((current_price - hist_month["Close"].iloc[-7]) / hist_month["Close"].iloc[-7]) * 100
price_change_30d = ((current_price - hist_month["Close"].iloc[0]) / hist_month["Close"].iloc[0]) * 100
```

**Finnhub (dla price + wszystkich fundamentals):**
```python
from app.services.finnhub_client import FinnhubClient

finnhub = FinnhubClient()

# Price z quote
quote = finnhub.get_quote(symbol)
current_price = quote['c']

# Market Cap z profile (konwersja z milion√≥w!)
profile = finnhub.get_company_profile(symbol)
market_cap = int(profile['marketCapitalization'] * 1_000_000)

# Fundamentals z basic_financials
fundamentals = finnhub.get_fundamentals(symbol)
metrics = fundamentals['metric']

roe = metrics['roeTTM']  # ‚úÖ
debt_equity = metrics['totalDebt/totalEquityAnnual']  # ‚úÖ
revenue_growth = metrics['revenueGrowthTTMYoy']  # ‚úÖ
pe = metrics['peTTM']  # ‚úÖ

# ROIC (ROCE) z series (NIE metrics!)
roic_series = fundamentals['series']['annual']['roic']
roce = roic_series[0]['v'] * 100  # konwersja z decimal na %
```

---

## üìä KOMPLETNO≈öƒÜ DANYCH - TABELA

| Metryka | ≈πr√≥d≈Ço | Status | Przyk≈Çad (AAPL) | Uwagi |
|---------|--------|--------|-----------------|-------|
| **Price** | Finnhub `/quote` | ‚úÖ | $256.48 | Realtime |
| **Volume** | yfinance | ‚úÖ | (z history) | Finnhub nie ma! |
| **Market Cap** | Finnhub `/company-profile2` | ‚úÖ | $3.8T | Konwersja z M |
| **ROE** | Finnhub metrics | ‚úÖ | 154.92% | `roeTTM` |
| **ROCE** | Finnhub series | ‚úÖ | 56.99% | `series.annual.roic[0].v` |
| **Debt/Equity** | Finnhub metrics | ‚úÖ | 1.8881 | `totalDebt/totalEquityAnnual` |
| **Revenue Growth** | Finnhub metrics | ‚úÖ | 5.97% | `revenueGrowthTTMYoy` |
| **P/E** | Finnhub metrics | ‚úÖ | 38.38 | `peTTM` |
| **Net Margin** | Finnhub metrics | ‚úÖ | 24.3% | `netProfitMarginTTM` |
| **Operating Margin** | Finnhub metrics | ‚úÖ | 31.87% | `operatingMarginTTM` |
| **Price Change 7d** | yfinance | ‚úÖ | (calculated) | Z history 1mo |
| **Price Change 30d** | yfinance | ‚úÖ | (calculated) | Z history 1mo |

---

## üîë PRAWID≈ÅOWE KLUCZE FINNHUB

### ‚ùå CZƒòSTE B≈ÅƒòDY (co NIE dzia≈Ça):

```python
# B≈ÅƒÑD 1: roicTTM nie istnieje!
roce = metrics.get('roicTTM', 0)  # ‚ùå NIE MA TAKIEGO KLUCZA

# B≈ÅƒÑD 2: totalDebtToEquity nie istnieje!
debt_equity = metrics.get('totalDebtToEquity', 999)  # ‚ùå NIE MA TAKIEGO KLUCZA

# B≈ÅƒÑD 3: Pr√≥ba pobrania revenue growth z series (zbyt z≈Ço≈ºone)
revenue_growth = # obliczenia z series...  # ‚ùå Niepotrzebnie skomplikowane
```

### ‚úÖ PRAWID≈ÅOWE KLUCZE:

```python
# ‚úÖ ROCE z series (NIE metrics!)
roic_series = fundamentals['series']['annual'].get('roic', [])
roce = roic_series[0]['v'] * 100 if roic_series else 0  # Konwersja decimal ‚Üí %

# ‚úÖ Debt/Equity (z "/" w kluczu!)
debt_equity = metrics.get('totalDebt/totalEquityAnnual', 999)

# ‚úÖ Revenue Growth (bezpo≈õrednio z metrics)
revenue_growth = metrics.get('revenueGrowthTTMYoy', 0)

# ‚úÖ ROE (bezpo≈õrednio z metrics, ju≈º w %)
roe = metrics.get('roeTTM', 0)

# ‚úÖ P/E Ratio
forward_pe = metrics.get('peTTM', 999)
```

---

## üìÅ PLIKI UTWORZONE W COMMICIE

### 1. `backend/FINNHUB_STATUS.md`
**Przeznaczenie:** Kompletna analiza co dzia≈Ça na FREE tier (ten plik)

### 2. `backend/debug_finnhub_metrics.py`
**Przeznaczenie:** Wy≈õwietla WSZYSTKIE 131 dostƒôpnych metryk dla AAPL
**U≈ºycie:**
```bash
cd backend
python debug_finnhub_metrics.py
```

### 3. `backend/test_finnhub_all_endpoints.py`
**Przeznaczenie:** Testuje wszystkie endpointy Finnhub (quote, candles, profile, financials)
**U≈ºycie:**
```bash
cd backend
python test_finnhub_all_endpoints.py
```
**Wynik:** Pokazuje kt√≥re endpointy zwracajƒÖ 200 (OK), a kt√≥re 403 (Forbidden)

### 4. `backend/test_finnhub_quote.py`
**Przeznaczenie:** Potwierdza ≈ºe `/quote` endpoint **NIE ma volume** (v = None)
**U≈ºycie:**
```bash
cd backend
python test_finnhub_quote.py
```

### 5. `backend/test_scanner_metrics.py`
**Przeznaczenie:** Test czy scanner.py poprawnie pobiera fundamentals z Finnhub
**U≈ºycie:**
```bash
cd backend
python test_scanner_metrics.py
```

---

## üöÄ ZMIANY W SCANNER.PY

### Co zosta≈Ço poprawione:

**Linie 111-114:** Market Cap konwersja z milion√≥w
```python
# BY≈ÅO:
market_cap = metrics.get('marketCapitalization', 0)

# JEST:
market_cap = metrics.get('marketCapitalization', 0)
market_cap = int(market_cap * 1_000_000) if market_cap else 0  # Konwersja z M
```

**Linie 119-127:** ROCE z series.annual (NIE metrics!)
```python
# BY≈ÅO:
roce = metrics.get('roicTTM', 0)  # ‚ùå nie istnieje

# JEST:
roce = 0
if 'series' in fundamentals and 'annual' in fundamentals['series']:
    roic_series = fundamentals['series']['annual'].get('roic', [])
    if roic_series and len(roic_series) > 0:
        roce = roic_series[0].get('v', 0) * 100 if roic_series[0].get('v') else 0  # ‚úÖ
```

**Linia 131:** Debt/Equity prawid≈Çowy klucz
```python
# BY≈ÅO:
debt_equity = metrics.get('totalDebtToEquity', 999)  # ‚ùå nie istnieje

# JEST:
debt_equity = metrics.get('totalDebt/totalEquityAnnual', 999)  # ‚úÖ z "/" w kluczu
```

**Linia 137:** Revenue Growth bezpo≈õrednio z metrics
```python
# BY≈ÅO:
# Skomplikowane obliczenia z series...

# JEST:
revenue_growth = metrics.get('revenueGrowthTTMYoy', 0)  # ‚úÖ bezpo≈õrednio z metrics
```

---

## üîç WNIOSKI I REKOMENDACJE

### ‚úÖ Co zadzia≈Ça≈Ço:
1. **Finnhub FREE tier ma 131 metryk fundamentalnych** - to wiƒôcej ni≈º potrzebujemy!
2. **Hybrid approach dzia≈Ça:** yfinance (volume) + Finnhub (fundamentals)
3. **Wszystkie kluczowe metryki dla multibagger scanner sƒÖ dostƒôpne GRATIS**

### ‚ö†Ô∏è Ograniczenia FREE tier:
1. **Brak volume w `/quote`** - wymaga yfinance
2. **Brak OHLCV candles** (403) - wymaga yfinance dla price changes
3. **Brak pe≈Çnych financials** (403) - ale basic_financials wystarczajƒÖ

### üìå Dalsze kroki:

#### Zrobione (commit 161f45b):
- ‚úÖ Testy wszystkich endpoint√≥w Finnhub
- ‚úÖ Identyfikacja prawid≈Çowych kluczy metryk
- ‚úÖ Poprawki w scanner.py (linie 109-137)
- ‚úÖ Pliki testowe (debug_finnhub_metrics.py, test_finnhub_all_endpoints.py, etc.)
- ‚úÖ Dokumentacja FINNHUB_STATUS.md

#### TODO (nastƒôpny commit):
- [ ] **Przetestowaƒá scanner.py end-to-end** na AAPL, MSFT, NVDA
- [ ] **Zweryfikowaƒá czy wszystkie metryki majƒÖ warto≈õci** (nie sƒÖ 0/None)
- [ ] **Dodaƒá error handling** dla przypadk√≥w gdy series.annual.roic nie istnieje
- [ ] **Zoptymalizowaƒá liczbƒô request√≥w** (rate limit: 60 calls/min na FREE tier)
- [ ] **Dodaƒá unit testy** dla scanner.py z mockami Finnhub responses

---

## üìö REFERENCJE

### Dokumentacja Finnhub API:
- Quote: https://finnhub.io/docs/api/quote
- Company Profile: https://finnhub.io/docs/api/company-profile2
- Basic Financials: https://finnhub.io/docs/api/company-basic-financials

### Limity FREE tier:
- **60 API calls/minute**
- **30 API calls/second** (burst)
- **No credit card required**

### Konfiguracja (backend/app/config.py):
```python
FINNHUB_API_KEY = os.getenv("FINNHUB_API_KEY", "default_key")
```

---

**Status implementacji:** ‚úÖ **GOTOWE DO TEST√ìW**
**Problem rozwiƒÖzany:** Volume z yfinance, fundamentals z Finnhub
**Nastƒôpny krok:** End-to-end testy na wielu symbolach (AAPL, MSFT, NVDA, GOOGL, TSLA)

---

*Raport wygenerowany: 2025-10-07*
*Commit: 161f45b20cc9dffdabb4f60e6e93887f8eb98c7c*
*Autor analizy: Claude (PM Agent)*
